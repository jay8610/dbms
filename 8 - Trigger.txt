-- ========= 1. SETUP THE TABLES =========
DROP TABLE IF EXISTS lib_Audit;
DROP TABLE IF EXISTS lib_book;

-- Create the main table
CREATE TABLE lib_book(
    bid INT PRIMARY KEY, 
    bname VARCHAR(20), 
    qty INT
);

-- Create the Audit table with two *new* columns
CREATE TABLE lib_Audit(
    audit_id INT AUTO_INCREMENT PRIMARY KEY, -- Good to have a primary key
    bid INT, 
    bname VARCHAR(20), 
    qty INT,
    action_type VARCHAR(10),   -- To store 'UPDATE' or 'DELETE'
    action_time DATETIME DEFAULT CURRENT_TIMESTAMP -- To store *when* it happened
);

-- Insert the sample data
INSERT INTO lib_book VALUES(1,'DBMS',70);
INSERT INTO lib_book VALUES(2,'SPOS',40);
INSERT INTO lib_book VALUES(3,'SPM',10);
INSERT INTO lib_book VALUES(4,'CNS',60);
INSERT INTO lib_book VALUES(5,'TOC',20);

-- ========= 2. CREATE THE TRIGGERS =========
-- We must create two separate triggers. This is the correct MySQL way.

DELIMITER //

-- Trigger 1: For UPDATE operations
CREATE TRIGGER trg_book_after_update
  AFTER UPDATE ON lib_book
  FOR EACH ROW
BEGIN
    -- Insert the *OLD* data into the audit table
    INSERT INTO lib_Audit (bid, bname, qty, action_type)
    VALUES (OLD.bid, OLD.bname, OLD.qty, 'UPDATE');
END;
//

-- Trigger 2: For DELETE operations
CREATE TRIGGER trg_book_after_delete
  AFTER DELETE ON lib_book
  FOR EACH ROW
BEGIN
    -- Insert the *OLD* data that was deleted
    INSERT INTO lib_Audit (bid, bname, qty, action_type)
    VALUES (OLD.bid, OLD.bname, OLD.qty, 'DELETE');
END;
//

DELIMITER ;

-- ========= 3. TESTING THE TRIGGERS =========

-- Check the tables before we do anything
SELECT * FROM lib_book;
SELECT * FROM lib_Audit;
-- (lib_Audit is empty)


-- --- Test 1: Update a book ---
UPDATE lib_book SET qty = 30 WHERE bid = 5;

-- --- Test 2: Delete a book ---
DELETE FROM lib_book WHERE bid = 4;


-- --- Final Check ---
-- The main table shows the new, changed data
SELECT * FROM lib_book;

-- The audit table now has a perfect log of the *old* data
SELECT * FROM lib_Audit;