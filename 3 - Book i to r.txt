create table borrower (
rollno int primary key,
name varchar (20),
idate date,
bname varchar (40),
status char (1)
);

create table fine (
rollno int primary key,
date date,
amt decimal (10,2)
);

insert into borrower values
(1, 'Ram', date_sub(curdate(), interval 10 day), 'cs fundamentals','I'),
(2, 'Ravi', date_sub(curdate(), interval 20 day), 'dsa','I'),
(3, 'Jay', date_sub(curdate(), interval 35 day), 'oop','I'),
(4, 'Priya', date_sub(curdate(), interval 40 day), 'sql basics','R');

delimiter//
create procedure p_returnbook(
 in p_rollno int,
 in p_bname varchar (40)
)
begin
declare v_idate date;
declare v_daycnt int;
declare v_fineamt decimal (10,2) default 0;
declare v_bookfound int default 1;
declare continue handler for not found set v_bookfound = 0;
select idate into v_idate
from borrower
where rollno = p_rollno
and bname = p_bname
and status = 'I';
if v_bookfound = 0 then
select 'exception: book not found or already returned' as message;
else
set v_daycnt = datediff(curdate(), v_idate);
if v_daycnt > 30 then
set v_fineamt = (15*5) + ((v_daycnt - 30) * 50);
elseif v_daycnt > 15 then
set v_fineamt = (v_daycnt - 15) * 5;
end if;
update borrower 
set status = 'R'
where rollno = p_rollno and bname = p_bname;
if v_fineamt > 0 then
insert into fine (rollno, date, amt)
values (p_rollno, curdate(), v_fineamt);
select concat('Book returned. Fine of Rs: ', v_fineamt, 'applied.') as message;
else
select 'Book returned no fine.' as message;
end if;
end if;
end //
delimiter ;
call p_returnbook(1,'cs fundamentals');
call p_returnbook(2,'dsa');
call p_returnbook(3,'oop');
call p_returnbook(4,'sql basics');
select * from fine;




